---
title: L06-获取用户发送的消息
date: 2021-09-13 10:46:46
tags: 微信公众号、前端、web
categories: 微信公众号开发
cover: https://tva1.sinaimg.cn/large/008i3skNly1guet2ld37aj60nq09k0tb02.jpg
---

# **L06-获取用户发送的消息**
1、精简auth.js  

![](https://tva1.sinaimg.cn/large/008i3skNly1guet4b4exvj614y0cqabj02.jpg)  

- 将以上代码转化为：  

![](https://tva1.sinaimg.cn/large/008i3skNly1guet4xk9zhj60yu02aq3102.jpg)

2、将signature比对放到GET请求下  

![](https://tva1.sinaimg.cn/large/008i3skNly1guet5pi0jfj60zu0fm75f02.jpg)  

3、POST请求下验证消息是否来自服务器  

![](https://tva1.sinaimg.cn/large/008i3skNly1guet6dcta5j60tm0bwq3u02.jpg)  

4、测试
- 重启服务器
- 打开接口测试号，发送一条消息，观察控制台是否打印消息  

![](https://tva1.sinaimg.cn/large/008i3skNly1guetajens3j60tw0bcgmd02.jpg)

- openid是用户微信的id，每个用户都不一样  
  
- 如果开发者服务器没有返回响应为微信服务器，微信服务器会发送三次请求过来，可以先用`res.end(‘’);`返回（后续再删掉）  

5、接受请求体中的数据（流式数据)  

- 编写一个getUserDataAsync()方法  

![](https://tva1.sinaimg.cn/large/008i3skNly1guetc9wluwj616u0oggo102.jpg)  

- 使用async函数来接收这个流式数据  

![](https://tva1.sinaimg.cn/large/008i3skNly1guetdlf5eej60sg03y74k02.jpg)  

6、测试接收结果
- 重启服务器  
  
- 在测试号发送一条消息，观察控制台  

![](https://tva1.sinaimg.cn/large/008i3skNly1guete6qv6lj60y809oq4302.jpg)  

- `<ToUserName>`：开发者id
- `<FromUserName>`：用户openid
- `<CreateTime>`：发送的时间戳
- `<MsgType>`：发送的消息类型
- `<Content>`：发送的内容
- `<MsgId>`：消息id 微信服务器会默认保存3天用户发送的数据，通过此id3天内就能找到消息数据  

7、为了拿到数据，我们需要将xml数据解析成js对象
- 定义一个parseXMLAsync(xmlData)方法，在tool.js中编写  

- 需要用到一个库(xml2js)，终端输入`nom i xml2js`进行下载安装

![](https://tva1.sinaimg.cn/large/008i3skNly1guetg3nescj610q0oktao02.jpg)  

8、测试解析结果  

![](https://tva1.sinaimg.cn/large/008i3skNly1guetgy37avj60xc0400t002.jpg)  

- 重启服务器，测试号发送一条消息，观察控制台打印的结果  

![](https://tva1.sinaimg.cn/large/008i3skNly1gueth9kklbj60x00e0q3s02.jpg)

9、怎么提取我们想要的信息？
- 解析出来的结果，很多都不是我们想要的，为了今后能够更方便的使用这些数据，我们对其进行格式化，使其成为（名称：内容）的格式进行输出  

- 在tool.js中定义一个新方法：formatMessage(jsData)，来获取有用的数据  

- 注意：将value里的第一个值赋值给message

![](https://tva1.sinaimg.cn/large/008i3skNly1guf1ezuwu7j60vi0m4jt602.jpg)

10、测试输出结果
- 同步方法，不需要添加await关键字了

![](https://tva1.sinaimg.cn/large/008i3skNly1guetjok4ekj60wk04cglu02.jpg)  

![](https://tva1.sinaimg.cn/large/008i3skNly1guf1fbljy4j60uy098t9802.jpg)